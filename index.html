<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم مدیریت لابراتوار</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* استایل کامل از کد قبلی */
        :root {
            --primary-color: #6d28d9;
            --primary-light: #8b5cf6;
            --primary-dark: #4c1d95;
            --secondary-color: #f59e0b;
            --secondary-light: #fbbf24;
            --secondary-dark: #d97706;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f3e8ff 0%, #fef3c7 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        }

        .login-box {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-logo {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .login-title {
            color: var(--primary-dark);
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-form {
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background: var(--light-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(109, 40, 217, 0.1);
            background: white;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            border-right: 4px solid #ef4444;
        }

        /* Main Application */
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            border-radius: var(--radius);
            padding: 25px 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 900;
            box-shadow: var(--shadow);
        }

        .lab-info h1 {
            color: white;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .lab-info p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 50px;
            color: white;
            position: relative;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Tabs */
        .tabs-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .tabs {
            display: flex;
            background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            overflow-x: auto;
            padding: 5px;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            white-space: nowrap;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.8);
            position: relative;
        }

        .tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            color: white;
            background: rgba(255,255,255,0.15);
        }

        .tab.active::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: var(--secondary-color);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 35px;
            background: var(--card-bg);
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content h2 {
            color: var(--primary-dark);
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #f8fafc 100%);
            border-radius: var(--radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin: 15px 0;
            color: var(--primary-dark);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
        }

        td {
            padding: 16px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
        }

        tr:hover td {
            background: rgba(109, 40, 217, 0.05);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, var(--secondary-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #f87171 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #60a5fa 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Badges */
        .badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-right-radius: var(--radius);
            border-top-left-radius: var(--radius);
        }

        .modal-body {
            padding: 30px;
        }

        /* Alert */
        .alert {
            padding: 20px 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            display: none;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left-color: #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left-color: #ef4444;
        }

        /* Chart Container */
        .chart-container {
            height: 350px;
            margin-top: 25px;
            position: relative;
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        /* Floating Buttons */
        .floating-buttons {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition);
            position: relative;
        }

        .floating-btn:hover {
            transform: scale(1.15) translateY(-5px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
        }

        .floating-btn .tooltip {
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--dark-color);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .floating-btn:hover .tooltip {
            opacity: 1;
        }

        .floating-btn.sync {
            background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
        }

        .floating-btn.sync.syncing {
            animation: pulse 2s infinite;
            background: linear-gradient(135deg, var(--warning-color) 0%, var(--secondary-light) 100%);
        }

        .floating-btn.sync.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
        }

        .floating-btn.sync.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #f87171 100%);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-online {
            background: #d1fae5;
            color: #065f46;
        }

        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-syncing {
            background: #fef3c7;
            color: #92400e;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 1 calc(50% - 10px);
                min-width: 150px;
                justify-content: center;
                padding: 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .floating-buttons {
                bottom: 70px;
                left: 10px;
            }
            
            .floating-btn .tooltip {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-flask"></i>
            </div>
            <h1 class="login-title">سیستم مدیریت لابراتوار</h1>
            <p class="login-subtitle">ورود به پنل مدیریت</p>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">نام کاربری</label>
                    <input type="text" id="username" class="form-control" placeholder="admin" required>
                </div>
                
                <div class="form-group">
                    <label for="password">رمز عبور</label>
                    <div class="password-input">
                        <input type="password" id="password" class="form-control" placeholder="••••••••" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                </button>
                
                <div id="loginError" class="login-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>نام کاربری یا رمز عبور نادرست است</span>
                </div>
            </form>
            
            <div style="margin-top: 30px; color: var(--text-secondary); font-size: 13px;">
                <p>برای ورود اولیه به پشتیبانی سیستم در تماس شوید:</p>
                <p>تماس: <strong>0797877773</strong></p>
                <p>ایمیل: <strong>anwary.dev@gmail.com</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-content">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="logo-container">
                    <div class="logo">آ</div>
                    <div class="lab-info">
                        <h1 id="labTitle">سیستم مدیریت لابراتوار</h1>
                        <p id="labSubtitle">پشتیبانی: 0797877773</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div>
                        <div id="userName">مدیر سیستم</div>
                        <div id="userRole" style="font-size: 12px; opacity: 0.8;">مدیریت</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </header>

            <!-- Floating Buttons -->
            <div class="floating-buttons">
                <button class="floating-btn sync" onclick="forceSync()" id="syncFloatingBtn">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span class="tooltip">همگام‌سازی ابری</span>
                </button>
                <button class="floating-btn" onclick="showTab('patients')">
                    <i class="fas fa-user-plus"></i>
                    <span class="tooltip">بیمار جدید</span>
                </button>
                <button class="floating-btn" onclick="showTab('examinations')">
                    <i class="fas fa-stethoscope"></i>
                    <span class="tooltip">معاینه جدید</span>
                </button>
                <button class="floating-btn" onclick="quickPrint()">
                    <i class="fas fa-print"></i>
                    <span class="tooltip">چاپ گزارش</span>
                </button>
                <button class="floating-btn" onclick="showTab('settings')">
                    <i class="fas fa-cog"></i>
                    <span class="tooltip">تنظیمات</span>
                </button>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab active" data-tab="dashboard">
                        <i class="fas fa-home"></i> داشبورد
                    </div>
                    <div class="tab" data-tab="patients">
                        <i class="fas fa-user-injured"></i> بیماران
                    </div>
                    <div class="tab" data-tab="examinations">
                        <i class="fas fa-stethoscope"></i> معاینات
                    </div>
                    <div class="tab" data-tab="financial">
                        <i class="fas fa-chart-line"></i> مالی
                    </div>
                    <div class="tab" data-tab="reports">
                        <i class="fas fa-file-alt"></i> گزارشات
                    </div>
                    <div class="tab" data-tab="settings">
                        <i class="fas fa-cog"></i> تنظیمات
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h2><i class="fas fa-home"></i> داشبورد مدیریتی</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div class="stat-value" id="totalPatients">0</div>
                            <div class="stat-label">بیماران کل</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave"></i>
                            <div class="stat-value" id="dailyIncome">0 <small>افغانی</small></div>
                            <div class="stat-label">درآمد امروز</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="stat-value" id="pendingExams">0</div>
                            <div class="stat-label">معاینات در انتظار</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-bar"></i>
                            <div class="stat-value" id="monthlyIncome">0 <small>افغانی</small></div>
                            <div class="stat-label">درآمد ماه جاری</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-history"></i> آخرین معاینات</h3>
                        <div class="table-responsive">
                            <table id="recentExams">
                                <thead>
                                    <tr>
                                        <th>نام بیمار</th>
                                        <th>نوع آزمایش</th>
                                        <th>پزشک</th>
                                        <th>هزینه</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="recentExamsBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-chart-bar"></i> آمار هفتگی</h3>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Patients Tab -->
                <div id="patients" class="tab-content">
                    <h2><i class="fas fa-user-injured"></i> مدیریت بیماران</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-user-plus"></i> ثبت بیمار جدید</h3>
                        <form id="patientForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>نام *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label>تخلص *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                                <div class="form-group">
                                    <label>نام پدر</label>
                                    <input type="text" class="form-control" id="fatherName">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>تذکره / پاسپورت</label>
                                    <input type="text" class="form-control" id="nationalId">
                                </div>
                                <div class="form-group">
                                    <label>تاریخ تولد</label>
                                    <input type="date" class="form-control" id="birthDate">
                                </div>
                                <div class="form-group">
                                    <label>جنسیت</label>
                                    <select class="form-control" id="gender">
                                        <option value="مرد">مرد</option>
                                        <option value="زن">زن</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>شماره تماس *</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                                <div class="form-group">
                                    <label>ولایت</label>
                                    <input type="text" class="form-control" id="province">
                                </div>
                                <div class="form-group">
                                    <label>ناحیه</label>
                                    <input type="text" class="form-control" id="district">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>آدرس دقیق</label>
                                <textarea class="form-control" id="address" rows="2"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>یادداشت</label>
                                <textarea class="form-control" id="notes" rows="2"></textarea>
                            </div>
                            
                            <div class="form-row" style="margin-top: 30px;">
                                <button type="button" class="btn btn-success" onclick="savePatient()">
                                    <i class="fas fa-save"></i> ذخیره بیمار
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetPatientForm()">
                                    <i class="fas fa-times"></i> پاک کردن
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-list"></i> لیست بیماران</h3>
                        <div class="table-responsive">
                            <table id="patientsTable">
                                <thead>
                                    <tr>
                                        <th>کد بیمار</th>
                                        <th>نام</th>
                                        <th>تذکره</th>
                                        <th>تماس</th>
                                        <th>تاریخ ثبت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="patientsTableBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Examinations Tab -->
                <div id="examinations" class="tab-content">
                    <h2><i class="fas fa-stethoscope"></i> مدیریت معاینات</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> ثبت معاینه جدید</h3>
                        <form id="examinationForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>بیمار *</label>
                                    <select class="form-control" id="patientId" required>
                                        <option value="">انتخاب بیمار</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>تاریخ معاینه *</label>
                                    <input type="date" class="form-control" id="examDate" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>نوع آزمایش *</label>
                                    <select class="form-control" id="examType" required>
                                        <option value="">انتخاب کنید</option>
                                        <option value="خون">آزمایش خون</option>
                                        <option value="ادرار">آزمایش ادرار</option>
                                        <option value="بیوشیمی">بیوشیمی</option>
                                        <option value="هماتولوژی">هماتولوژی</option>
                                        <option value="سرمولوژی">سرمولوژی</option>
                                        <option value="هورمون">هورمون</option>
                                        <option value="کشت">کشت میکروب</option>
                                        <option value="پاتولوژی">پاتولوژی</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>پزشک معالج</label>
                                    <input type="text" class="form-control" id="doctor">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>هزینه (افغانی) *</label>
                                    <input type="number" class="form-control" id="price" required min="0">
                                </div>
                                <div class="form-group">
                                    <label>وضعیت پرداخت</label>
                                    <select class="form-control" id="paymentStatus">
                                        <option value="پرداخت شده">پرداخت شده</option>
                                        <option value="در انتظار">در انتظار پرداخت</option>
                                        <option value="بیمه">بیمه</option>
                                        <option value="تخفیف">تخفیف</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>توضیحات و نتایج</label>
                                <textarea class="form-control" id="examNotes" rows="4"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>وضعیت معاینه</label>
                                <select class="form-control" id="examStatus">
                                    <option value="در انتظار">در انتظار</option>
                                    <option value="انجام شده">انجام شده</option>
                                    <option value="تایید شده">تایید شده</option>
                                    <option value="لغو شده">لغو شده</option>
                                </select>
                            </div>
                            
                            <div class="form-row" style="margin-top: 30px;">
                                <button type="button" class="btn btn-success" onclick="saveExamination()">
                                    <i class="fas fa-save"></i> ذخیره معاینه
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetExamForm()">
                                    <i class="fas fa-times"></i> پاک کردن
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-list"></i> لیست معاینات</h3>
                        <div class="table-responsive">
                            <table id="examsTable">
                                <thead>
                                    <tr>
                                        <th>کد بیمار</th>
                                        <th>نام بیمار</th>
                                        <th>نوع آزمایش</th>
                                        <th>پزشک</th>
                                        <th>هزینه</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="examsTableBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Financial Tab -->
                <div id="financial" class="tab-content">
                    <h2><i class="fas fa-chart-line"></i> گزارشات مالی</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave"></i>
                            <div class="stat-value" id="totalIncome">0 <small>افغانی</small></div>
                            <div class="stat-label">درآمد کل</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-calendar-day"></i>
                            <div class="stat-value" id="todayIncome">0 <small>افغانی</small></div>
                            <div class="stat-label">درآمد امروز</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="stat-value" id="pendingPayments">0 <small>افغانی</small></div>
                            <div class="stat-label">در انتظار پرداخت</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-exchange-alt"></i> تراکنش‌های مالی</h3>
                        <div class="table-responsive">
                            <table id="financialTable">
                                <thead>
                                    <tr>
                                        <th>تاریخ</th>
                                        <th>بیمار</th>
                                        <th>نوع</th>
                                        <th>توضیحات</th>
                                        <th>مبلغ (افغانی)</th>
                                        <th>وضعیت</th>
                                    </tr>
                                </thead>
                                <tbody id="financialTableBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content">
                    <h2><i class="fas fa-file-alt"></i> گزارشات</h2>
                    
                    <div class="card">
                        <h3><i class="fas fa-calendar-day"></i> گزارش روزانه</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>از تاریخ</label>
                                <input type="date" class="form-control" id="reportFrom">
                            </div>
                            <div class="form-group">
                                <label>تا تاریخ</label>
                                <input type="date" class="form-control" id="reportTo">
                            </div>
                            <div class="form-group">
                                <label style="visibility: hidden;">.</label>
                                <button class="btn btn-primary" type="button" onclick="generateCustomReport()">
                                    <i class="fas fa-search"></i> ایجاد گزارش
                                </button>
                            </div>
                        </div>
                        
                        <div id="reportResults" style="display: none; margin-top: 20px;">
                            <!-- Report results will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="tab-content">
                    <h2><i class="fas fa-cog"></i> تنظیمات سیستم</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="card">
                            <h3><i class="fas fa-flask"></i> تنظیمات لابراتوار</h3>
                            <form id="settingsForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>نام لابراتوار *</label>
                                        <input type="text" class="form-control" id="labName" required>
                                    </div>
                                    <div class="form-group">
                                        <label>شماره تماس *</label>
                                        <input type="text" class="form-control" id="labPhone" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>آدرس</label>
                                        <textarea class="form-control" id="labAddress" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>واحد پول</label>
                                        <select class="form-control" id="currency">
                                            <option value="افغانی">افغانی</option>
                                            <option value="دلار">دلار آمریکا</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>زبان</label>
                                        <select class="form-control" id="language">
                                            <option value="fa">دری</option>
                                            <option value="en">انگلیسی</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="margin-top: 30px;">
                                    <button type="button" class="btn btn-success" onclick="saveSettings()">
                                        <i class="fas fa-save"></i> ذخیره تنظیمات
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h3><i class="fas fa-shield-alt"></i> تنظیمات امنیتی</h3>
                            
                            <div class="form-group">
                                <label>نام کاربری فعلی</label>
                                <input type="text" class="form-control" id="currentUsername" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label>تغییر رمز عبور</label>
                                <div class="password-input">
                                    <input type="password" class="form-control" id="newPassword" placeholder="رمز عبور جدید">
                                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>تکرار رمز عبور</label>
                                <div class="password-input">
                                    <input type="password" class="form-control" id="confirmPassword" placeholder="تکرار رمز عبور">
                                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>رمز فعلی برای تأیید</label>
                                <div class="password-input">
                                    <input type="password" class="form-control" id="currentPassword" placeholder="رمز عبور فعلی">
                                    <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> تغییر رمز عبور
                            </button>
                        </div>
                    </div>
                    
                    <!-- بخش تنظیمات همگام‌سازی ابری -->
                    <div class="card" style="margin-top: 30px;">
                        <h3><i class="fas fa-cloud"></i> همگام‌سازی ابری</h3>
                        
                        <div class="form-group">
                            <label><i class="fas fa-key"></i> GitHub Personal Access Token</label>
                            <div class="password-input">
                                <input type="password" id="githubToken" class="form-control" 
                                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                <button type="button" class="password-toggle" onclick="togglePassword('githubToken')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> 
                                فقط در دستگاه اول نیاز است
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> نام کاربری GitHub</label>
                            <input type="text" id="githubUsername" class="form-control" placeholder="username">
                            <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> 
                                فقط در دستگاه اول نیاز است
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-database"></i> Gist ID (برای اتصال دستگاه‌های دیگر)</label>
                            <input type="text" id="gistId" class="form-control" placeholder="gist_id_here">
                            <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> 
                                در دستگاه دوم فقط این ID را وارد کنید
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-cloud"></i> وضعیت اتصال</label>
                            <div id="syncStatusDisplay" style="padding: 10px; background: var(--light-color); 
                                 border-radius: 5px; font-size: 13px; margin-top: 5px;">
                                <span class="connection-status status-offline">
                                    <i class="fas fa-cloud-slash"></i>
                                    <span>قطع اتصال</span>
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">
                                <i class="fas fa-save"></i> ذخیره تنظیمات
                            </button>
                            <button class="btn btn-success" onclick="connectWithGistId()" id="connectBtn">
                                <i class="fas fa-plug"></i> اتصال با Gist ID
                            </button>
                            <button class="btn btn-danger" onclick="disconnectCloud()">
                                <i class="fas fa-unlink"></i> قطع اتصال
                            </button>
                        </div>
                        
                        <div id="githubTestResult" style="margin-top: 15px; display: none;"></div>
                        
                        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid var(--border-color);">
                            <h4><i class="fas fa-info-circle"></i> راهنمای همگام‌سازی</h4>
                            <ol style="margin-right: 20px; margin-top: 10px; color: var(--text-secondary);">
                                <li>در دستگاه <strong>اول</strong>: توکن و نام کاربری GitHub را وارد کرده و ذخیره کنید</li>
                                <li>Gist ID ایجاد شده را کپی کنید</li>
                                <li>در دستگاه <strong>دوم</strong>: فقط Gist ID را وارد کرده و "اتصال با Gist ID" را بزنید</li>
                                <li>داده‌ها به صورت خودکار همگام می‌شوند</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>در حال بارگذاری...</p>
            </div>

            <!-- Alerts -->
            <div id="alertSuccess" class="alert alert-success" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>عملیات با موفقیت انجام شد.</span>
            </div>
            
            <div id="alertError" class="alert alert-error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span>خطا در انجام عملیات.</span>
            </div>
        </div>
    </div>

    <script>
    // ==================== GLOBAL VARIABLES ====================
    let patients = [];
    let examinations = [];
    let settings = {};
    let loginHistory = [];
    let users = {};
    let editingPatientId = null;
    let editingExamId = null;
    let currentLanguage = 'fa';
    let weeklyChart = null;
    let currentOperation = null;
    let cloudGistId = null;
    let autoSyncInterval = null;
    let lastSyncTime = null;
    let isCloudConnected = false;
    let syncHistory = [];

    // ==================== CLOUD CONFIGURATION ====================
    const CLOUD_CONFIG = {
        token: '',
        username: '',
        gistId: '',
        autoSync: true,
        syncInterval: 30000
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 سیستم مدیریت لابراتوار در حال راه‌اندازی...');
        
        initLoginSystem();
        loadCloudConfig();
        updateCloudStatus();
        
        // Setup event listeners
        setupEventListeners();
        
        console.log('✅ سیستم آماده است');
    });

    function setupEventListeners() {
        // Login form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            login();
        });
        
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                showTab(tabName);
            });
        });
        
        // Patient search
        const searchInput = document.getElementById('searchPatient');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#patientsTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        // Set today's date for exam form
        const today = new Date().toISOString().split('T')[0];
        const examDateInput = document.getElementById('examDate');
        if (examDateInput) {
            examDateInput.value = today;
        }
    }

    // ==================== LOGIN SYSTEM ====================
    function initLoginSystem() {
        initUsers();
        
        const isLoggedIn = localStorage.getItem('lab_logged_in');
        const currentUser = localStorage.getItem('lab_current_user');
        
        if (isLoggedIn === 'true' && currentUser && users[currentUser]) {
            console.log('✅ کاربر وارد شده است:', currentUser);
            showMainApp();
            loadAllData();
        } else {
            console.log('🔐 نیاز به ورود');
            showLoginPage();
        }
    }

    function initUsers() {
        const savedUsers = localStorage.getItem('lab_users');
        if (savedUsers) {
            try {
                const usersArray = JSON.parse(savedUsers);
                users = {};
                usersArray.forEach(user => {
                    users[user.username] = user;
                });
            } catch (e) {
                console.error('❌ خطا در بارگذاری کاربران:', e);
                users = {};
            }
        } else {
            users = {};
        }
        
        if (!users['admin']) {
            users['admin'] = {
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                created: new Date().toISOString(),
                name: 'مدیر سیستم'
            };
            saveUsers();
        }
    }

    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorDiv = document.getElementById('loginError');
        
        if (users[username] && users[username].password === password) {
            localStorage.setItem('lab_logged_in', 'true');
            localStorage.setItem('lab_current_user', username);
            
            showMainApp();
            loadAllData();
            
            showAlert('success', 'ورود موفقیت‌آمیز بود. خوش آمدید!');
            
        } else {
            errorDiv.style.display = 'block';
            document.getElementById('password').value = '';
        }
    }

    function logout() {
        Swal.fire({
            title: 'خروج از سیستم',
            text: 'آیا از خروج از سیستم مطمئن هستید؟',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'بله، خروج',
            cancelButtonText: 'لغو',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('lab_logged_in');
                localStorage.removeItem('lab_current_user');
                showLoginPage();
            }
        });
    }

    function showLoginPage() {
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('username').value = 'admin';
        document.getElementById('password').value = 'admin123';
    }

    function showMainApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').classList.add('active');
        
        const currentUser = localStorage.getItem('lab_current_user');
        const userInfo = users[currentUser];
        document.getElementById('userName').textContent = userInfo?.name || currentUser || 'مدیر سیستم';
        document.getElementById('currentUsername').value = currentUser || 'admin';
    }

    // ==================== DATA MANAGEMENT ====================
    async function loadAllData() {
        console.log('📂 بارگذاری همه داده‌ها...');
        showLoading();
        
        try {
            patients = JSON.parse(localStorage.getItem('lab_patients') || '[]');
            examinations = JSON.parse(localStorage.getItem('lab_examinations') || '[]');
            
            const savedSettings = JSON.parse(localStorage.getItem('lab_settings') || '{}');
            settings = savedSettings;
            
            if (patients.length === 0 && examinations.length === 0) {
                initializeSampleData();
            }
            
            applySettings();
            loadPatientsTable();
            loadPatientsSelect();
            loadExaminations();
            updateDashboard();
            
            console.log('✅ بارگذاری داده‌ها کامل شد');
            
        } catch (error) {
            console.error('❌ خطا در بارگذاری داده‌ها:', error);
            showAlert('error', 'خطا در بارگذاری داده‌ها');
        } finally {
            hideLoading();
        }
    }

    async function saveAllData() {
        console.log('💾 ذخیره همه داده‌ها...');
        try {
            localStorage.setItem('lab_patients', JSON.stringify(patients));
            localStorage.setItem('lab_examinations', JSON.stringify(examinations));
            localStorage.setItem('lab_settings', JSON.stringify(settings));
            console.log('✅ داده‌ها در حافظه محلی ذخیره شدند');
        } catch (error) {
            console.error('❌ خطا در ذخیره داده‌ها:', error);
        }
    }

    function applySettings() {
        document.title = settings.labName || 'سیستم مدیریت لابراتوار';
        document.getElementById('labTitle').textContent = settings.labName || 'سیستم مدیریت لابراتوار';
        document.getElementById('labSubtitle').textContent = `پشتیبانی: ${settings.labPhone || '0797877773'}`;
    }

    // ==================== PATIENT MANAGEMENT ====================
    async function savePatient() {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        
        if (!firstName || !lastName || !phone) {
            showAlert('error', 'لطفاً فیلدهای الزامی (نام، تخلص، شماره تماس) را پر کنید.');
            return;
        }
        
        const patient = {
            id: editingPatientId || Date.now(),
            code: 'P' + (patients.length + 1000).toString().padStart(4, '0'),
            firstName: firstName,
            lastName: lastName,
            fatherName: document.getElementById('fatherName').value.trim(),
            nationalId: document.getElementById('nationalId').value.trim(),
            birthDate: document.getElementById('birthDate').value,
            gender: document.getElementById('gender').value,
            phone: phone,
            province: document.getElementById('province').value.trim(),
            district: document.getElementById('district').value.trim(),
            address: document.getElementById('address').value.trim(),
            notes: document.getElementById('notes').value.trim(),
            createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        if (editingPatientId) {
            const index = patients.findIndex(p => p.id === editingPatientId);
            if (index !== -1) {
                patients[index] = patient;
            }
        } else {
            patients.push(patient);
        }
        
        await saveAllData();
        loadPatientsTable();
        loadPatientsSelect();
        resetPatientForm();
        
        showAlert('success', editingPatientId ? 
            'اطلاعات بیمار ویرایش شد.' : 
            'بیمار جدید با موفقیت ثبت شد.');
        
        editingPatientId = null;
    }

    function loadPatientsSelect() {
        const select = document.getElementById('patientId');
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">انتخاب بیمار</option>';
        
        patients.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient.id;
            option.textContent = `${patient.firstName} ${patient.lastName} (${patient.code}) - ${patient.phone}`;
            select.appendChild(option);
        });
        
        if (currentValue) {
            select.value = currentValue;
        }
    }

    function loadPatientsTable() {
        const tbody = document.getElementById('patientsTableBody');
        tbody.innerHTML = '';
        
        if (patients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-users fa-3x" style="margin-bottom: 15px;"></i>
                        <h4>هیچ بیمار ی ثبت نشده است</h4>
                    </td>
                </tr>
            `;
            return;
        }
        
        patients.forEach(patient => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${patient.code}</td>
                <td>${patient.firstName} ${patient.lastName}</td>
                <td>${patient.nationalId || '---'}</td>
                <td>${patient.phone}</td>
                <td>${formatDate(patient.createdAt)}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="editPatient(${patient.id})" title="ویرایش">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePatient(${patient.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function resetPatientForm() {
        document.getElementById('patientForm').reset();
        editingPatientId = null;
        document.getElementById('birthDate').value = '1990-01-01';
    }

    function editPatient(id) {
        const patient = patients.find(p => p.id === id);
        if (!patient) return;
        
        editingPatientId = id;
        
        document.getElementById('firstName').value = patient.firstName;
        document.getElementById('lastName').value = patient.lastName;
        document.getElementById('fatherName').value = patient.fatherName || '';
        document.getElementById('nationalId').value = patient.nationalId || '';
        document.getElementById('birthDate').value = patient.birthDate || '1990-01-01';
        document.getElementById('gender').value = patient.gender;
        document.getElementById('phone').value = patient.phone;
        document.getElementById('province').value = patient.province || '';
        document.getElementById('district').value = patient.district || '';
        document.getElementById('address').value = patient.address || '';
        document.getElementById('notes').value = patient.notes || '';
        
        showTab('patients');
        
        showAlert('info', 'در حال ویرایش بیمار. پس از تغییرات، دکمه "ذخیره بیمار" را بزنید.');
    }

    async function deletePatient(id) {
        Swal.fire({
            title: 'حذف بیمار',
            text: 'آیا از حذف این بیمار مطمئن هستید؟',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'بله، حذف کن',
            cancelButtonText: 'لغو',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280'
        }).then(async (result) => {
            if (result.isConfirmed) {
                patients = patients.filter(p => p.id !== id);
                await saveAllData();
                loadPatientsTable();
                loadPatientsSelect();
                showAlert('success', 'بیمار حذف شد.');
            }
        });
    }

    // ==================== EXAMINATION MANAGEMENT ====================
    async function saveExamination() {
        const patientId = parseInt(document.getElementById('patientId').value);
        const patient = patients.find(p => p.id === patientId);
        
        if (!patient) {
            showAlert('error', 'لطفاً بیمار را انتخاب کنید.');
            return;
        }
        
        const price = parseFloat(document.getElementById('price').value);
        if (!price || price <= 0) {
            showAlert('error', 'لطفاً هزینه معتبر وارد کنید.');
            return;
        }
        
        const exam = {
            id: editingExamId || Date.now(),
            patientId: patientId,
            patientName: `${patient.firstName} ${patient.lastName}`,
            patientCode: patient.code,
            date: document.getElementById('examDate').value,
            type: document.getElementById('examType').value,
            doctor: document.getElementById('doctor').value,
            price: price,
            paymentStatus: document.getElementById('paymentStatus').value,
            status: document.getElementById('examStatus').value,
            notes: document.getElementById('examNotes').value,
            createdAt: editingExamId ? examinations.find(e => e.id === editingExamId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        if (editingExamId) {
            const index = examinations.findIndex(e => e.id === editingExamId);
            if (index !== -1) {
                examinations[index] = exam;
            }
        } else {
            examinations.push(exam);
        }
        
        await saveAllData();
        loadExaminations();
        resetExamForm();
        
        showAlert('success', editingExamId 
            ? 'معاینه ویرایش شد.'
            : 'معاینه جدید ثبت شد.');
        
        editingExamId = null;
    }

    function loadExaminations() {
        const tbody = document.getElementById('examsTableBody');
        tbody.innerHTML = '';
        
        if (examinations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-stethoscope fa-3x" style="margin-bottom: 15px;"></i>
                        <h4>هیچ معاینه‌ای ثبت نشده است</h4>
                    </td>
                </tr>
            `;
            return;
        }
        
        examinations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .forEach(exam => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exam.patientCode}</td>
                <td>${exam.patientName}</td>
                <td>${exam.type}</td>
                <td>${exam.doctor || '---'}</td>
                <td>${exam.price.toLocaleString()} افغانی</td>
                <td>${exam.status}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-warning btn-sm" onclick="editExam(${exam.id})" title="ویرایش">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteExam(${exam.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function editExam(id) {
        const exam = examinations.find(e => e.id === id);
        if (!exam) return;
        
        editingExamId = id;
        
        document.getElementById('patientId').value = exam.patientId;
        document.getElementById('examDate').value = exam.date;
        document.getElementById('examType').value = exam.type;
        document.getElementById('doctor').value = exam.doctor || '';
        document.getElementById('price').value = exam.price;
        document.getElementById('paymentStatus').value = exam.paymentStatus;
        document.getElementById('examStatus').value = exam.status;
        document.getElementById('examNotes').value = exam.notes || '';
        
        showTab('examinations');
        
        showAlert('info', 'در حال ویرایش معاینه. پس از تغییرات، دکمه "ذخیره معاینه" را بزنید.');
    }

    async function deleteExam(id) {
        Swal.fire({
            title: 'حذف معاینه',
            text: 'آیا از حذف این معاینه مطمئن هستید؟',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'بله، حذف کن',
            cancelButtonText: 'لغو',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280'
        }).then(async (result) => {
            if (result.isConfirmed) {
                examinations = examinations.filter(e => e.id !== id);
                await saveAllData();
                loadExaminations();
                showAlert('success', 'معاینه حذف شد.');
            }
        });
    }

    function resetExamForm() {
        document.getElementById('examinationForm').reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('examDate').value = today;
        editingExamId = null;
        document.getElementById('patientId').value = '';
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function updateDashboard() {
        const today = new Date().toISOString().split('T')[0];
        const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
            .toISOString().split('T')[0];
        
        const todayPatients = examinations
            .filter(e => e.date === today)
            .map(e => e.patientId)
            .filter((value, index, self) => self.indexOf(value) === index).length;
        
        const todayIncome = examinations
            .filter(e => e.date === today)
            .reduce((sum, e) => sum + e.price, 0);
        
        const pendingExams = examinations
            .filter(e => e.status === 'در انتظار').length;
        
        const monthlyIncome = examinations
            .filter(e => e.date >= firstDayOfMonth)
            .reduce((sum, e) => sum + e.price, 0);
        
        document.getElementById('totalPatients').textContent = patients.length;
        document.getElementById('dailyIncome').textContent = todayIncome.toLocaleString();
        document.getElementById('pendingExams').textContent = pendingExams;
        document.getElementById('monthlyIncome').textContent = monthlyIncome.toLocaleString();
        
        updateRecentExams();
        updateWeeklyChart();
    }

    function updateRecentExams() {
        const tbody = document.getElementById('recentExamsBody');
        tbody.innerHTML = '';
        
        const recentExams = examinations
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .slice(0, 5);
        
        if (recentExams.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        هیچ معاینه‌ای ثبت نشده است
                    </td>
                </tr>
            `;
        } else {
            recentExams.forEach(exam => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.patientName}</td>
                    <td>${exam.type}</td>
                    <td>${exam.doctor || '---'}</td>
                    <td>${exam.price.toLocaleString()} افغانی</td>
                    <td>${exam.status}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editExam(${exam.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    function updateWeeklyChart() {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        
        if (weeklyChart) {
            weeklyChart.destroy();
        }
        
        const labels = [];
        const patientsData = [];
        const incomeData = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            const dayNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه'];
            const day = dayNames[date.getDay()];
            labels.push(day);
            
            const dayPatients = examinations
                .filter(e => e.date === dateStr)
                .map(e => e.patientId)
                .filter((value, index, self) => self.indexOf(value) === index).length;
            
            const dayIncome = examinations
                .filter(e => e.date === dateStr)
                .reduce((sum, e) => sum + e.price, 0);
            
            patientsData.push(dayPatients);
            incomeData.push(dayIncome);
        }
        
        weeklyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'تعداد بیماران',
                        data: patientsData,
                        backgroundColor: '#6d28d9',
                        yAxisID: 'y'
                    },
                    {
                        label: `درآمد (افغانی)`,
                        data: incomeData,
                        backgroundColor: '#f59e0b',
                        type: 'line',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'تعداد بیماران'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: `درآمد (افغانی)`
                        }
                    }
                }
            }
        });
    }

    // ==================== FINANCIAL FUNCTIONS ====================
    function updateFinancialData() {
        const today = new Date().toISOString().split('T')[0];
        const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
            .toISOString().split('T')[0];
        
        const totalIncome = examinations.reduce((sum, e) => sum + e.price, 0);
        const todayIncome = examinations
            .filter(e => e.date === today)
            .reduce((sum, e) => sum + e.price, 0);
        const pendingPayments = examinations
            .filter(e => e.paymentStatus === 'در انتظار')
            .reduce((sum, e) => sum + e.price, 0);
        
        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
        document.getElementById('todayIncome').textContent = todayIncome.toLocaleString();
        document.getElementById('pendingPayments').textContent = pendingPayments.toLocaleString();
        
        updateFinancialTable();
    }

    function updateFinancialTable() {
        const tbody = document.getElementById('financialTableBody');
        tbody.innerHTML = '';
        
        examinations.sort((a, b) => new Date(b.date) - new Date(a.date))
            .forEach(exam => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exam.date}</td>
                <td>${exam.patientName}</td>
                <td>${exam.type}</td>
                <td>${exam.doctor || 'بدون پزشک'}</td>
                <td>${exam.price.toLocaleString()}</td>
                <td>${exam.paymentStatus}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // ==================== CLOUD SYNC SYSTEM ====================
    function loadCloudConfig() {
        CLOUD_CONFIG.token = localStorage.getItem('github_token') || '';
        CLOUD_CONFIG.username = localStorage.getItem('github_username') || '';
        CLOUD_CONFIG.gistId = localStorage.getItem('cloud_gist_id') || '';
        
        cloudGistId = CLOUD_CONFIG.gistId;
        
        // Update form fields
        document.getElementById('githubToken').value = CLOUD_CONFIG.token;
        document.getElementById('githubUsername').value = CLOUD_CONFIG.username;
        document.getElementById('gistId').value = cloudGistId;
    }

    function saveCloudConfig() {
        localStorage.setItem('github_token', CLOUD_CONFIG.token);
        localStorage.setItem('github_username', CLOUD_CONFIG.username);
        localStorage.setItem('cloud_gist_id', CLOUD_CONFIG.gistId);
    }

    async function saveGitHubSettings() {
        const token = document.getElementById('githubToken').value.trim();
        const username = document.getElementById('githubUsername').value.trim();
        
        if (!token || !username) {
            showAlert('error', 'لطفاً توکن و نام کاربری GitHub را وارد کنید');
            return;
        }

        CLOUD_CONFIG.token = token;
        CLOUD_CONFIG.username = username;
        saveCloudConfig();

        updateCloudStatus('syncing', 'در حال تست اتصال...');
        
        try {
            // Test connection
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                // Create new Gist if doesn't exist
                if (!cloudGistId) {
                    await createNewGist();
                }
                
                updateCloudStatus('online', 'متصل به ابر');
                isCloudConnected = true;
                startAutoSync();
                
                showAlert('success', '✅ تنظیمات ابری با موفقیت ذخیره شد');
                
            } else {
                throw new Error('اتصال ناموفق');
            }
        } catch (error) {
            showAlert('error', '❌ خطا در اتصال به GitHub');
            updateCloudStatus('offline', 'اتصال ناموفق');
        }
    }

    async function createNewGist() {
        try {
            const initialData = {
                patients: patients,
                examinations: examinations,
                settings: settings,
                users: Object.values(users),
                metadata: {
                    created: new Date().toISOString(),
                    system: 'Lab Management System',
                    version: '3.0',
                    createdBy: CLOUD_CONFIG.username
                }
            };

            const gistData = {
                description: 'Lab System Cloud Storage',
                public: false,
                files: {
                    'lab_system_data.json': {
                        content: JSON.stringify(initialData, null, 2)
                    }
                }
            };

            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${CLOUD_CONFIG.token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                throw new Error(`خطای ${response.status}`);
            }

            const result = await response.json();
            cloudGistId = result.id;
            CLOUD_CONFIG.gistId = result.id;
            saveCloudConfig();
            
            document.getElementById('gistId').value = cloudGistId;
            
            console.log('✅ Gist جدید ایجاد شد:', cloudGistId);
            return cloudGistId;

        } catch (error) {
            console.error('❌ خطا در ایجاد ابر:', error);
            throw error;
        }
    }

    async function connectWithGistId() {
        const gistId = document.getElementById('gistId').value.trim();
        
        if (!gistId) {
            showAlert('error', 'لطفاً Gist ID را وارد کنید');
            return;
        }
        
        showLoading();
        updateCloudStatus('syncing', 'در حال اتصال...');
        updateSyncButton('syncing');
        
        try {
            // Test Gist access
            const response = await fetch(`https://api.github.com/gists/${gistId}`);
            
            if (!response.ok) {
                throw new Error('Gist ID نامعتبر است');
            }
            
            // Save Gist ID
            CLOUD_CONFIG.gistId = gistId;
            cloudGistId = gistId;
            saveCloudConfig();
            
            // Load data from cloud
            await loadFromCloud();
            
            updateCloudStatus('online', 'متصل به ابر');
            updateSyncButton('success');
            isCloudConnected = true;
            
            showAlert('success', '✅ اتصال با موفقیت برقرار شد');
            
            // Start auto sync
            startAutoSync();
            
        } catch (error) {
            console.error('❌ خطا در اتصال:', error);
            updateCloudStatus('offline', 'خطا در اتصال');
            updateSyncButton('error');
            showAlert('error', '❌ خطا در اتصال به ابر');
        } finally {
            hideLoading();
        }
    }

    async function loadFromCloud() {
        if (!cloudGistId) {
            throw new Error('Gist ID تنظیم نشده است');
        }
        
        console.log('☁️ بارگیری از ابر...');
        
        try {
            const response = await fetch(`https://api.github.com/gists/${cloudGistId}`);
            
            if (!response.ok) {
                throw new Error(`خطای ${response.status}`);
            }

            const gist = await response.json();
            const file = gist.files['lab_system_data.json'];

            if (!file) {
                throw new Error('فایل داده یافت نشد');
            }

            const allData = JSON.parse(file.content);

            // Load data
            patients = allData.patients || [];
            examinations = allData.examinations || [];
            settings = allData.settings || {};
            
            if (allData.users && allData.users.length > 0) {
                users = {};
                allData.users.forEach(user => {
                    users[user.username] = user;
                });
                saveUsers();
            }

            // Save to local storage
            saveAllData();
            
            // Update UI
            loadPatientsTable();
            loadPatientsSelect();
            loadExaminations();
            updateDashboard();
            
            console.log('✅ بارگیری ابری موفق');
            
            return true;

        } catch (error) {
            console.error('❌ خطا در بارگیری از ابر:', error);
            throw error;
        }
    }

    async function saveToCloud() {
        if (!cloudGistId) {
            throw new Error('Gist ID تنظیم نشده است');
        }
        
        console.log('☁️ ذخیره در ابر...');
        
        try {
            const allData = {
                patients: patients,
                examinations: examinations,
                settings: settings,
                users: Object.values(users),
                metadata: {
                    lastSync: new Date().toISOString(),
                    device: navigator.userAgent.substring(0, 100),
                    timestamp: Date.now()
                }
            };

            const gistData = {
                description: `Lab System Sync - ${new Date().toLocaleString('fa-IR')}`,
                files: {
                    'lab_system_data.json': {
                        content: JSON.stringify(allData, null, 2)
                    }
                }
            };

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            };

            // Add token if available
            if (CLOUD_CONFIG.token) {
                headers['Authorization'] = `token ${CLOUD_CONFIG.token}`;
            }

            const response = await fetch(`https://api.github.com/gists/${cloudGistId}`, {
                method: 'PATCH',
                headers: headers,
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`خطای ${response.status}: ${errorText}`);
            }

            console.log('✅ ذخیره ابری موفق');
            return true;

        } catch (error) {
            console.error('❌ خطا در ذخیره ابری:', error);
            throw error;
        }
    }

    async function forceSync() {
        if (!isCloudConnected || !cloudGistId) {
            showAlert('warning', 'لطفاً ابتدا به ابر متصل شوید');
            showTab('settings');
            return;
        }
        
        console.log('🔄 شروع همگام‌سازی دستی...');
        updateSyncButton('syncing');
        
        try {
            // Save to cloud
            await saveToCloud();
            
            // Load from cloud (to ensure sync)
            await loadFromCloud();
            
            updateSyncButton('success');
            showAlert('success', '✅ همگام‌سازی کامل انجام شد');
            
        } catch (error) {
            console.error('❌ خطا در همگام‌سازی:', error);
            updateSyncButton('error');
            showAlert('error', '❌ خطا در همگام‌سازی');
        }
    }

    function disconnectCloud() {
        Swal.fire({
            title: 'قطع اتصال از ابر',
            text: 'آیا از قطع اتصال از ذخیره‌سازی ابری مطمئن هستید؟',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'بله، قطع کن',
            cancelButtonText: 'لغو',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280'
        }).then((result) => {
            if (result.isConfirmed) {
                CLOUD_CONFIG.token = '';
                CLOUD_CONFIG.username = '';
                CLOUD_CONFIG.gistId = '';
                cloudGistId = null;
                isCloudConnected = false;
                
                // Clear from localStorage
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_username');
                localStorage.removeItem('cloud_gist_id');
                
                // Stop auto sync
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                }
                
                // Reset form
                document.getElementById('githubToken').value = '';
                document.getElementById('githubUsername').value = '';
                document.getElementById('gistId').value = '';
                
                updateCloudStatus('offline', 'قطع اتصال');
                updateSyncButton('offline');
                
                showAlert('success', '✅ اتصال از ابر قطع شد');
            }
        });
    }

    function startAutoSync() {
        if (!cloudGistId) return;

        console.log('⏰ راه‌اندازی همگام‌سازی خودکار...');
        
        if (autoSyncInterval) {
            clearInterval(autoSyncInterval);
        }

        autoSyncInterval = setInterval(async () => {
            if (document.visibilityState === 'visible' && isCloudConnected) {
                try {
                    console.log('🔄 همگام‌سازی خودکار در حال انجام...');
                    await saveToCloud();
                    
                    // Load from cloud every 5 minutes
                    if (!lastSyncTime || Date.now() - lastSyncTime > 300000) {
                        await loadFromCloud();
                        lastSyncTime = Date.now();
                    }
                } catch (error) {
                    console.error('❌ خطا در همگام‌سازی خودکار:', error);
                }
            }
        }, CLOUD_CONFIG.syncInterval);
    }

    function updateCloudStatus(status, message) {
        const syncStatusDisplay = document.getElementById('syncStatusDisplay');
        if (!syncStatusDisplay) return;

        let icon = 'fa-cloud';
        let statusClass = 'status-offline';
        let text = 'قطع اتصال';
        
        switch(status) {
            case 'online':
                icon = 'fa-cloud-check';
                statusClass = 'status-online';
                text = message || 'متصل به ابر';
                break;
            case 'offline':
                icon = 'fa-cloud-slash';
                statusClass = 'status-offline';
                text = message || 'قطع اتصال';
                break;
            case 'syncing':
                icon = 'fa-cloud-upload-alt';
                statusClass = 'status-syncing';
                text = message || 'در حال همگام‌سازی';
                break;
        }

        syncStatusDisplay.innerHTML = `
            <span class="connection-status ${statusClass}">
                <i class="fas ${icon}"></i>
                <span>${text}</span>
            </span>
        `;
    }

    function updateSyncButton(status) {
        const button = document.getElementById('syncFloatingBtn');
        if (!button) return;

        button.className = 'floating-btn sync';
        
        switch(status) {
            case 'syncing':
                button.classList.add('syncing');
                button.innerHTML = `
                    <i class="fas fa-sync fa-spin"></i>
                    <span class="tooltip">در حال همگام‌سازی...</span>
                `;
                break;
            case 'success':
                button.classList.add('success');
                button.innerHTML = `
                    <i class="fas fa-cloud-check"></i>
                    <span class="tooltip">همگام‌سازی موفق</span>
                `;
                setTimeout(() => {
                    button.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span class="tooltip">همگام‌سازی ابری</span>
                    `;
                    button.className = 'floating-btn sync';
                }, 3000);
                break;
            case 'error':
                button.classList.add('error');
                button.innerHTML = `
                    <i class="fas fa-cloud-slash"></i>
                    <span class="tooltip">خطا در همگام‌سازی</span>
                `;
                setTimeout(() => {
                    button.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span class="tooltip">همگام‌سازی ابری</span>
                    `;
                    button.className = 'floating-btn sync';
                }, 3000);
                break;
        }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.parentNode.querySelector('.password-toggle i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const tabContent = document.getElementById(tabName);
        if (tabContent) {
            tabContent.classList.add('active');
        }
        
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.getAttribute('data-tab') === tabName) {
                tab.classList.add('active');
            }
        });
        
        switch(tabName) {
            case 'patients':
                loadPatientsTable();
                break;
            case 'examinations':
                loadExaminations();
                loadPatientsSelect();
                break;
            case 'financial':
                updateFinancialData();
                break;
            case 'dashboard':
                updateDashboard();
                break;
            case 'settings':
                const currentUser = localStorage.getItem('lab_current_user');
                if (currentUser) {
                    document.getElementById('currentUsername').value = currentUser;
                }
                document.getElementById('labName').value = settings.labName || 'سیستم مدیریت لابراتوار';
                document.getElementById('labPhone').value = settings.labPhone || '0797877773';
                document.getElementById('labAddress').value = settings.labAddress || '';
                document.getElementById('currency').value = settings.currency || 'افغانی';
                document.getElementById('language').value = settings.language || 'fa';
                
                // Update cloud status
                if (cloudGistId && isCloudConnected) {
                    updateCloudStatus('online', 'متصل به ابر');
                } else {
                    updateCloudStatus('offline', 'قطع اتصال');
                }
                break;
        }
    }

    function saveSettings() {
        settings = {
            labName: document.getElementById('labName').value,
            labPhone: document.getElementById('labPhone').value,
            labAddress: document.getElementById('labAddress').value,
            currency: document.getElementById('currency').value,
            language: document.getElementById('language').value,
            lastModified: new Date().toISOString()
        };
        
        localStorage.setItem('lab_settings', JSON.stringify(settings));
        applySettings();
        
        showAlert('success', 'تنظیمات با موفقیت ذخیره شد.');
    }

    function changePassword() {
        const currentUser = localStorage.getItem('lab_current_user');
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!currentUser) {
            showAlert('error', 'کاربری یافت نشد!');
            return;
        }
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showAlert('error', 'لطفاً همه فیلدها را پر کنید.');
            return;
        }
        
        if (newPassword.length < 6) {
            showAlert('error', 'رمز عبور جدید باید حداقل ۶ کاراکتر باشد.');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showAlert('error', 'رمز عبور جدید و تکرار آن مطابقت ندارند.');
            return;
        }
        
        if (users[currentUser].password !== currentPassword) {
            showAlert('error', 'رمز عبور فعلی نادرست است.');
            return;
        }
        
        users[currentUser].password = newPassword;
        users[currentUser].lastPasswordChange = new Date().toISOString();
        saveUsers();
        
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        showAlert('success', 'رمز عبور با موفقیت تغییر یافت.');
    }

    function saveUsers() {
        const usersArray = Object.values(users);
        localStorage.setItem('lab_users', JSON.stringify(usersArray));
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fa-IR');
    }

    function showLoading() {
        document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loading').classList.remove('active');
    }

    function showAlert(type, message) {
        const alertDiv = type === 'success' 
            ? document.getElementById('alertSuccess')
            : document.getElementById('alertError');
        
        alertDiv.querySelector('span').textContent = message;
        alertDiv.style.display = 'flex';
        
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 3000);
    }

    function quickPrint() {
        const today = new Date().toISOString().split('T')[0];
        const todayExams = examinations.filter(e => e.date === today);
        
        if (todayExams.length === 0) {
            showAlert('warning', 'هیچ معاینه‌ای برای امروز ثبت نشده است.');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        const totalIncome = todayExams.reduce((sum, e) => sum + e.price, 0);
        
        printWindow.document.write(`
            <html dir="rtl">
            <head>
                <title>گزارش روزانه - ${today}</title>
                <style>
                    body { font-family: 'Vazirmatn', sans-serif; padding: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .summary { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 10px; text-align: right; border-bottom: 1px solid #ddd; }
                    th { background: #6d28d9; color: white; }
                    .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>${settings.labName || 'سیستم مدیریت لابراتوار'}</h1>
                    <h2>گزارش روزانه</h2>
                    <p>تاریخ: ${today}</p>
                </div>
                
                <div class="summary">
                    <p><strong>تعداد معاینات:</strong> ${todayExams.length}</p>
                    <p><strong>درآمد کل:</strong> ${totalIncome.toLocaleString()} افغانی</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>بیمار</th>
                            <th>نوع آزمایش</th>
                            <th>پزشک</th>
                            <th>هزینه</th>
                            <th>وضعیت</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${todayExams.map(exam => `
                            <tr>
                                <td>${exam.patientName}</td>
                                <td>${exam.type}</td>
                                <td>${exam.doctor || '---'}</td>
                                <td>${exam.price.toLocaleString()}</td>
                                <td>${exam.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="footer">
                    <p>${settings.labName || ''} - ${settings.labPhone || ''}</p>
                    <p>تاریخ چاپ: ${new Date().toLocaleDateString('fa-IR')}</p>
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function generateCustomReport() {
        const fromDate = document.getElementById('reportFrom').value;
        const toDate = document.getElementById('reportTo').value;
        
        if (!fromDate || !toDate) {
            showAlert('error', 'لطفاً تاریخ شروع و پایان را انتخاب کنید.');
            return;
        }
        
        const filteredExams = examinations.filter(exam => {
            return exam.date >= fromDate && exam.date <= toDate;
        });
        
        const totalExams = filteredExams.length;
        const totalIncome = filteredExams.reduce((sum, exam) => sum + exam.price, 0);
        const uniquePatients = [...new Set(filteredExams.map(exam => exam.patientId))].length;
        
        const reportResults = document.getElementById('reportResults');
        reportResults.style.display = 'block';
        reportResults.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <h4>نتایج گزارش از ${fromDate} تا ${toDate}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${totalExams}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">تعداد معاینات</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--success-color);">${totalIncome.toLocaleString()}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">درآمد کل (افغانی)</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--info-color);">${uniquePatients}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">بیماران منحصر</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== SAMPLE DATA ====================
    function initializeSampleData() {
        console.log('📝 ایجاد داده‌های نمونه...');
        
        if (patients.length === 0) {
            patients = [
                {
                    id: 1,
                    code: 'P1001',
                    firstName: 'احمد',
                    lastName: 'کریمی',
                    fatherName: 'محمد',
                    nationalId: '1234567890',
                    birthDate: '1985-03-15',
                    gender: 'مرد',
                    phone: '0799123456',
                    province: 'هرات',
                    district: 'مرکز',
                    address: 'هرات، شهر نو',
                    notes: 'بیمار دیابتی',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];
        }
        
        if (examinations.length === 0) {
            const today = new Date().toISOString().split('T')[0];
            
            examinations = [
                {
                    id: 1,
                    patientId: 1,
                    patientName: 'احمد کریمی',
                    patientCode: 'P1001',
                    date: today,
                    type: 'خون',
                    doctor: 'دکتر رحیمی',
                    price: 1500,
                    paymentStatus: 'پرداخت شده',
                    status: 'انجام شده',
                    notes: 'نتایج نرمال - قند خون: 95',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];
        }
        
        saveAllData();
        console.log('✅ داده‌های نمونه ایجاد شدند');
    }
    </script>
</body>
</html>
